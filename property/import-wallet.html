<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>导入钱包</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/import.css" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title"></h1>
			<i class="iconfont icon-saoma saoma_btn newact" url="code.html"></i>
		</header>
		<div class="mui-content">
			<ul class="import_nav">
				<li class="active_state choose">助记词</li>
				<li class="grey_state choose">私钥</li>
			</ul>
			<div class="import_main">
				<textarea id="keystoreString" rows="3" placeholder="输入助记词，用空格分隔" class="import_input"></textarea>
				<p class="import_alert">使用助记词导入的同时可以修改密码</p>
				<div class="between">
					<h4>重置密码</h4>
					<p class="limit">8-20位字符，不可以是纯数字</p>
					<div class="mui-input-row info">
						<input id="pass" value="" type="password" class="mui-input-password" placeholder="钱包密码">
					</div>
					<div class="mui-input-row info">
						<input id="ensurePass" type="password" class="mui-input-password" placeholder="再次输入钱包密码">
					</div>
					<div class="backup_button" id="leadIn">开始导入</div>
				</div>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/jquery-2.1.1.min.js"></script>
		<script src="../js/store/dist/store.legacy.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/benben.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/web3.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init()
			$('.choose').click(function() {
				$(this).addClass('active_state').removeClass("grey_state").siblings().addClass('grey_state').removeClass('active_state');
				if($(this).html() == '助记词') {
					$('.import_alert').html('使用助记词导入的同时可以修改密码');
					$('.import_input').attr('placeholder', '输入助记词，用空格分隔');
				};
				if($(this).html() == '私钥') {
					$('.import_alert').html('输入 Private Key 文件内容至输入框。或通过扫描 Private Key内容生成二维码录入');
					$('.import_input').attr('placeholder', '输入明文私钥');
				}
			})
			$("#leadIn").on("click", function() {
				if($("#keystoreString").val() == "") {
					mui.toast('私钥不能为空')
					return false;
				}
				if($("#pass").val() == "") {
					mui.toast('密码不能为空')
					return false;
				}
				if($("#ensurePass").val() == "") {
					mui.toast('请再次输入密码')
					return false;
				}
				if($("#pass").val() != $("#ensurePass").val()) {
					mui.toast('两次密码不一致')
					return false;
				}
				$("input").blur();
				var tiner = null;
				clearTimeout(tiner);
				tiner = setTimeout(function() {
					mui.showLoading("加载中...", "div");
					var time = null;
					clearTimeout(time);
					time = setTimeout(function() {
						// 创建 Web3 实例
						var web3 = new Web3();
						// 用户导入 keystore 文件
						var keystoreString = $("#keystoreString").val();
						// 转换为 JSON 文件
						var keystoreJsonV3 = JSON.parse(keystoreString);
						// 用户输入争取的密码
						var password = $("#pass").val();
						// 获取钱包信息
						try {
							var wallet = web3.eth.accounts.decrypt(keystoreJsonV3, password);
							var purse_data = store.get("dcarPurse");
							var eth_data = store.get("ethPurse");
							for(var i = 0; i < purse_data.length; i++) {
								if(purse_data[i].privateKey == wallet.privateKey) {
									eth_data.push(purse_data[i]);
								}
							}
							store.set('ethPurse', eth_data);
							mui.toast('钱包导入成功');
							var timer = null;
							clearTimeout(timer);
							timer = setTimeout(function() {
								plus.webview.getWebviewById("pages/property.html").evalJS("showEthPurse()");
								plus.webview.currentWebview().close();
							}, 1000);
						} catch(err) {
							mui.toast('密码或私钥错误');
						}
						mui.hideLoading();
					}, 10)
				}, 1000)
			})
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				targetId = self.targetId;
				if(targetId == 'dcar') {
					$(".mui-title").html('新建DCAR钱包');
				} else if(targetId == 'ETH') {
					$(".mui-title").html('导入ETH钱包');
				} else {
					$(".mui-title").html('导入BTC钱包');
				}
			})

			function getResult() {
				if(store.get("result") != undefined || store.get("result") != null) {
					$("#keystoreString").val(store.get("result"));
				}
			}
		</script>
	</body>

</html>