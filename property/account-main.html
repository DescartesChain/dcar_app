<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>账户首页</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/account.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title account_title"></h1>
		</header>
		<div class="mui-content">
			<div class="img_box" onclick="account_info()">
				<img src="../img/property/wallet.png" alt="" id="headPort"/>
			</div>
			<div class="wallet_title account_title"></div>
			<div class="wallet_address"></div>
			<div class="mui-row dcar_money" id="showAll">
				<div class="mui-col-sm-12 mui-col-xs-12">
					当前余额：<span class="orange_text ">2566.00</span> DCAR
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12" style="padding-top:10px;">
					矿收：<span class="green_text">2866.00</span> DCAR
				</div>
			</div>
			<div class="dcar_money" id="showHalf">
				当前余额：<span class="orange_text">2566.00</span> DCAR
			</div>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" onclick="wallet_address()">
					<a class="mui-navigate-right">
						钱包地址
					</a>
				</li>
				<li class="mui-table-view-cell" id="export">
					<a class="mui-navigate-right">
						导出助记词
					</a>
				</li>
				<li class="mui-table-view-cell" id="key">
					<a class="mui-navigate-right ">
						导出私钥
					</a>
				</li>
				<li class="mui-table-view-cell" id="keystore">
					<a class="mui-navigate-right">
						导出Keystore
					</a>
				</li>
				<li class="mui-table-view-cell newact" url="/users/tradeRecord.html">
					<a class="mui-navigate-right ">
						交易记录
					</a>
				</li>
			</ul>
		</div>
		<div class="mui-popover email_code_box">
			<div class="popover_header">
				<p>安全验证</p>
				<span id="cancel">取消</span>
			</div>
			<div class="popover_content">
				<p>请输入钱包密码</p>
				<div class="mui-input-row">
					<input type="password" class="mui-input-password" placeholder="请输入钱包密码" id="pass">
				</div>
				<div class="sure_box">
					<button type="button" class="mui-btn mui-btn-primary cannot newact showWord" id="ensure" url="/property/backup-wallet.html">确定</button>
					<button type="button" class="mui-btn mui-btn-primary cannot showKey" id="ensureImport">确定</button>
					<button type="button" class="mui-btn mui-btn-primary cannot showKeystore" id="sureKeystore">确定</button>
				</div>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/store/dist/store.legacy.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/benben.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery-2.1.1.min.js"></script>
		<script src="../js/web3.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();

			function init() {
				var self = plus.webview.currentWebview();
				purseIndex = self.purseIndex;
				var purseInfo = store.get('dcarPurse');
				$('.account_title').html(purseInfo[purseIndex].name);
			}

			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				targetId = self.targetId;
				purseIndex = self.purseIndex;
				var purseInfo = store.get('dcarPurse');
				$('.wallet_address').html(purseInfo[purseIndex].address);
				$('.account_title').html(purseInfo[purseIndex].name);
				// 判断钱包类型  1 dcar   2  ETH  3 BTC
				if(targetId == '1') {
					$("#headPort").attr("src", "../img/property/wallet.png");
					$('#showAll').show();
					$('#showHalf').hide();
				} else if(targetId == '2') {
					$("#headPort").attr("src", "../img/property/btn-ethereum.png");
					$('#showAll').hide();
					$('#showHalf').show();
				} else if(targetId == '3') {
					$('.account_title').html('BTC-Wallet');
					$("#headPort").attr("src", "../img/property/wallet.png");
					$('#showAll').hide();
					$('#showHalf').show();
				}
				// 判断密码是否为空
				$("#pass").keyup(function() {
					if($("#pass").val() == '') {
						$("#ensure").removeClass("can");
						$("#ensure").addClass("cannot");
						$("#ensureImport").removeClass("can");
						$("#ensureImport").addClass("cannot");
						$("#sureKeystore").removeClass("can");
						$("#sureKeystore").addClass("cannot");
					} else {
						$("#ensure").removeClass("cannot");
						$("#ensure").addClass("can");
						$("#ensureImport").removeClass("cannot");
						$("#ensureImport").addClass("can");
						$("#sureKeystore").removeClass("can");
						$("#sureKeystore").addClass("cannot");
					}
				})
				// 导出助记词
				$("#export").on("click", function() {
					$("#pass").val("");
					mui('.email_code_box').popover('toggle');
					$('.showWord').show();
					$('.showKey').hide();
					$('.showKeystore').hide();
				})
				$("#cancel").on("click", function() {
					mui('.email_code_box').popover('hide');
				})
				// 导出私钥
				$("#key").on("click", function() {
					$("#pass").val("");
					$('.showWord').hide();
					$('.showKey').show();
					$('.showKeystore').hide();
					mui('.email_code_box').popover('toggle');
				});
				// 导出keystore
				$("#keystore").on("click", function() {
					$("#pass").val("");
					$('.showWord').hide();
					$('.showKey').hide();
					$('.showKeystore').show();
					mui('.email_code_box').popover('toggle');
				})
			})

			// 导出私钥
			$("#ensureImport").on("click", function() {
				$("input").blur();
				var timer = null;
				clearTimeout(timer);
				timer = setTimeout(function() {
					mui.showLoading("加载中...", "div");
					var tiner = null;
					clearTimeout(tiner);
					tiner = setTimeout(function() {
						mui.hideLoading();
						var web3 = new Web3();
						var keystoreString = store.get('dcarPurse')[purseIndex].keystore;
						var keystoreJsonV3 = JSON.parse(keystoreString)
						var password = $("#pass").val();
						try {
							// 读取 钱包地址
							var wallet = web3.eth.accounts.decrypt(keystoreJsonV3, password);
							mui.openWindow({
								id: "/property/export-private-key.html",
								url: "/property/export-private-key.html",
								extras: {
									purseIndex: purseIndex,
								},
								waiting: {
									autoShow: false,
								}
							})
							console.log(wallet.address)
							console.log(wallet.privateKey)
						} catch(err) {
							mui.toast('密码输入错误');
						}
					}, 100)
				}, 1000)
				//				mui.showLoading("加载中...", "div");
				//				var web3 = new Web3();
				//				var keystoreString = store.get('dcarPurse')[purseIndex].keystore;
				//				var keystoreJsonV3 = JSON.parse(keystoreString)
				//				var password = $("#pass").val();
				//				try {
				//					// 读取 钱包地址
				//					var wallet = web3.eth.accounts.decrypt(keystoreJsonV3, password);
				//					mui.openWindow({
				//						id: "/property/export-private-key.html",
				//						url: "/property/export-private-key.html",
				//						extras: {
				//							purseIndex: purseIndex,
				//						},
				//						waiting: {
				//							autoShow: false,
				//						}
				//					})
				//					console.log(wallet.address)
				//					console.log(wallet.privateKey)
				//				} catch(err) {
				//					mui.toast('密码输入错误');
				//				}
			});

			// 导出keystore
			$("#sureKeystore").on("click", function() {
				$("input").blur();
				var timer = null;
				clearTimeout(timer);
				timer = setTimeout(function() {
					mui.showLoading("加载中...", "div");
					var tiner = null;
					clearTimeout(tiner);
					tiner = setTimeout(function() {
						mui.hideLoading();
						var web3 = new Web3();
						var keystoreString = store.get('dcarPurse')[purseIndex].keystore;
						var keystoreJsonV3 = JSON.parse(keystoreString)
						var password = $("#pass").val();
						try {
							// 读取 钱包地址
							var wallet = web3.eth.accounts.decrypt(keystoreJsonV3, password);
							mui.openWindow({
								id: "/property/export-keystore.html",
								url: "/property/export-keystore.html",
								extras: {
									purseIndex: purseIndex,
								},
								waiting: {
									autoShow: false,
								}
							})
							console.log(wallet.address)
							console.log(wallet.privateKey)
						} catch(err) {
							mui.toast('密码输入错误');
						}
					}, 100)
				}, 1000)
			});

			// 点击头像跳转到账户信息
			function account_info() {
				mui.openWindow({
					id: "../property/account-info.html",
					url: "../property/account-info.html",
					extras: {
						purseIndex: purseIndex
					},
				})
			}
			// 跳转到钱包地址
			function wallet_address() {
				mui.openWindow({
					id: "../property/wallet-address.html",
					url: "../property/wallet-address.html",
					extras: {
						purseIndex: purseIndex
					},
				})
			}
		</script>
	</body>

</html>