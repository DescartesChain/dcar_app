<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/oreManage.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">矿机管理</h1>
			<i class="iconfont icon-saoma mui-pull-right saoma_btn newact" url="/users/barcode.html"></i>
		</header>
		<div class="mui-content between">
			<div class="mill_top">
				<p class="first_line">总收益 (24h)</p>
				<p class="second_line">
					<span id="balance"></span>
					<span class="first_line">DCAR</span>
				</p>
				<p class="third_line">
					=
					<span id="balanceCNY"></span>
					CNY
				</p>
			</div>
			<div class="miner_list" id="cart_list">
				<!--<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">矿机一</h5>
							<p class="status stay">正在挖矿</p>
						</div>
						<div class="miner_content">
							<ul class="miner_income">
								<li>
									<h6>今日收益（24h）</h6>
									<p>452138.00<span>DCAR</span></p>
								</li>
								<li>
									<h6>算力值（KH/S）</h6>
									<p>452138.00<span>DCAR</span></p>
								</li>
							</ul>
							<p class="miner_address">矿机地址<span>wadsfafafafasdaffdddddfafasf</span></p>
						</div>
						<div class="miner_footer">
							<p class="shut_down open_box">
								<i class="iconfont icon-guanbizhuanhuan"></i> 关机
							</p>
							<p class="purse">
								<i class="iconfont icon-qianbao"></i> 钱包管理
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>-->
				<!--<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">矿机二</h5>
							<p class="status stop">
								<img src="../img/redPic.png" alt="" />
								停止挖矿
							</p>
						</div>
						<div class="miner_content">
							<ul class="miner_income">
								<li>
									<h6>今日收益（24h）</h6>
									<p>452138.00<span>DCAR</span></p>
								</li>
								<li>
									<h6>算力值（KH/S）</h6>
									<p>452138.00<span>DCAR</span></p>
								</li>
							</ul>
							<p class="miner_address">矿机地址<span>wadsfafafafasdaffdddddfafasf</span></p>
						</div>
						<div class="miner_footer_two">
							<p class="start_open open_box">
								<i class="iconfont icon-guanjin"></i> 开机
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>-->
			</div>
		</div>
		<!--开机关机弹框-->
		<div class="mui-popover alert_box">
			<p class="alert_title">提示</p>
			<div class="alert_body" id="close">确定要关机吗？确定之后矿机将停止挖矿</div>
			<div class="alert_body" id="delete">确定要删除吗？</div>
			<div class="alert_body" id="open">确定要开机吗？确定之后矿机将开始挖矿</div>
			<ul class="alert_operate">
				<li class="alert_button" onclick="sureConfirm()">确定</li>
				<li class="alert_button">取消</li>
			</ul>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/store/dist/store.legacy.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery-2.1.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/benben.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			loadmillList(); // 获取矿机列表
			var alertState;
			var currentId;
			var stateList = []; //矿机状态列表
			var millList = []; // 矿机列表
			var balanceTotal = 0; // 收益总和
			//定时加载
			var timer = null;
			clearInterval(timer);
			timer = setInterval(function(){
			   loadmillList(); // 获取矿机列表
			},60000)
			mui.plusReady(function() {
				$(".alert_button").on("click", function() {
					mui('.alert_box').popover('toggle');
				});
				$("#cart_list").on("click", ".purse", function() {
					clearInterval(timer);
					mui.openWindow({
						url: '/users/addOre.html',
						id: '/users/addOre.html',
						extras: {
							minerName: $(this).attr("name"),
							uuid: $(this).attr("uuid")
						},
						waiting: {
							autoShow: false,
						}
					})
			    });
			    // 开机
			    $("#cart_list").on("click", ".start_open", function() {
					mui('.alert_box').popover('show');
					alertState = 'open';
					currentId = $(this).attr("uuid");
					$('#delete').hide();
					$('#close').hide();
					$('#open').show();
				});
				// 关机
			    $("#cart_list").on("click", ".shut_down", function() {
					mui('.alert_box').popover('show');
					alertState = 'close';
					currentId = $(this).attr("uuid");
					$('#delete').hide();
					$('#close').show();
					$('#open').hide();
				});
				// 删除
				$("#cart_list").on("click", ".delete_miner", function() {
					mui('.alert_box').popover('show');
					alertState = 'delete';
					currentId = $(this).attr("uuid");
					$('#delete').show();
					$('#close').hide();
					$('#open').hide();
				});
			});
			// 确定 
			function sureConfirm(){
				if (alertState == 'delete') { // 删除矿机
					mui.showLoading("删除中...", "div");
					$.ajax({
						type: "delete",
						url: api + "miners/unbind/account",
						data: {
							uuid: currentId
						},
						beforeSend: function(xhr) {
							xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
						},
						async: true,
						success: function(ret) {
							mui.hideLoading();
							if(ret.success) {
								mui.toast('删除成功');
								loadmillList();
							} else {
								mui.toast(ret.msg);
							}
						},
						error: function(error) {
							mui.hideLoading();
							mui.toast(error.responseJSON.msg);
						}
					});
				} else if (alertState == 'open') { //启动矿机
					mui.showLoading("启动中...", "div");
					$.ajax({
						type: "get",
						url: api + "miners/" + currentId + '/init',
						data: {},
						beforeSend: function(xhr) {
							xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
						},
						async: true,
						success: function(ret) {
							mui.hideLoading();
							if(ret.success) {
								mui.toast('启动成功');
								loadmillList();
							} else {
								mui.toast(ret.msg);
							}
						},
						error: function(error) {
							mui.hideLoading();
							mui.toast(error.responseJSON.msg);
						}
					});
				}
			}
			var goods = [];
			var cart_list = '';
			// 获取矿机状态列表
			function loadStateList() {
				$.ajax({
				  type: "get",    // 接口类型
				  url: api + "miners/status",  // 接口地址
				  data: {},  // 参数
				  beforeSend: function(xhr) {
				    xhr.setRequestHeader('x-requested-with', store.get("userInfo").token); // 需要携带的头部
				  },
				  async: true,
				  success: function(ret) {
				    mui.hideLoading();
				    if(ret.success) {
				      mui.toast('加载成功');
				      stateList = ret.data; // 矿机状态列表
				      for(var b =0;b<stateList.length;b++){
				      	balanceTotal = balanceTotal + stateList[b].balance;
				      }
				      $('#balance').html(balanceTotal);
				      $('#balanceCNY').html(balanceTotal);
				    } else{
				      mui.toast(ret.msg);
				    }
				  },
				  error: function(error) {
				    mui.hideLoading();
				    mui.toast(error.responseJSON.msg);
				  }
				})
			}
			// 获取矿机列表
			function loadmillList() {
				loadStateList(); // 获取矿机状态列表
				$('#cart_list').empty();
				mui.showLoading("加载中...", "div");
				$.ajax({
					type: "get",
					url: api + "miners",
					data: {},
					beforeSend: function(xhr) {
						xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
					},
					async: true,
					success: function(ret) {
						mui.hideLoading();
						if(ret.success) {
							mui.toast('加载成功');
							millList = ret.data.list; //矿机列表
							mergeDate(); // 合并数据
						} else {
							mui.toast(ret.msg);
						}
					},
					error: function(error) {
						mui.hideLoading();
						mui.toast(error.responseJSON.msg);
					}
				})
			};
			// 合并数据
			function mergeDate(){
				cart_list = '';
				for(var i=0;i<millList.length;i++){
					for (var j=0;j<stateList.length;j++){
						if (i == j){
							millList[i].stateData = stateList[j];
						}
					}
				}
				complete(); // 最终合成
			};
			$("#cart_list").on("swipeleft", ".miner", function() {
				$(".miner_box").find(".delete_miner").css("right", "-85px")
				$(".miner_box").find(".miner").css("margin-left", "0")
				$(this).parent().find(".delete_miner").css("right", "0")
				$(this).parent().find(".miner").css("margin-left", "-85px")
			});
			$("#cart_list").on("swiperight", ".miner", function() {
				$(this).parent().find(".delete_miner").css("right", "-85px")
				$(this).parent().find(".miner").css("margin-left", "0")
			});
			// 合成页面
			function complete() {
				if(millList.length > 0) {
					$.each(millList, function(i, t) {
						if (t.stateData.uptime >0) {
							cart_list +=
							'<div class="miner_box">' +
								'<div class="miner">' +
									'<div class="title">' +
										'<h5 class="name">' + t.name + '</h5>' +
										'<p class="status" id="doing">' + 
											'<img src="../img/greenPic.png" alt="" />' +
											'挖矿中' +
										'</p>' +
									'</div>' +
									'<div class="miner_content">' +
										'<ul class="miner_income">' +
											'<li>' +
												'<h6>' + '今日收益（24h）' + '</h6>' +
												'<p>' + t.stateData.balance + '<span>' + 'DCAR' + '</span>' + '</p>' +
											'</li>' +
											'<li>' +
												'<h6>' + '算力值（KH/S）' + '</h6>' +
												'<p>' + t.stateData.hashrate + '<span>' + 'DCAR' + '</span>' + '</p>' +
											'</li>' +
										'</ul>' +
										'<p class="miner_address">' + '矿机地址' + '<span>' + 'wadsfafafafasdaffdddddfafasf' + '</span>' + '</p>' +
									'</div>' +
									'<div class="miner_footer">' +
										'<p class="shut_down open_box">' +
											'<i class="iconfont icon-guanbizhuanhuan"></i>' + '关机' +
										'</p>' +
										'<p class="purse" name="'+ t.name +'" uuid="'+ t.uuid +'">' +
											'<i class="iconfont icon-qianbao"></i>' + '添加钱包' +
										'</p>' +
									'</div>' +
								'</div>' +
								'<div class="delete_miner high_height" uuid="'+ t.uuid +'">' +
									'<i class="iconfont icon-shanchu"></i>' +
									'<p>' + '删除' + '</p>'+
								'</div>' +
							'</div>'
						} else {
							cart_list +=
							'<div class="miner_box">' +
								'<div class="miner">' +
									'<div class="title">' +
										'<h5 class="name">' + t.name + '</h5>' +
//													'<p class="status" id="staying">' + 
//														'<img src="../img/yellowPic.png" alt="" />' +
//														'空闲中' +
//													'</p>' +
										'<p class="status" id="closing">' + 
											'<img src="../img/redPic.png" alt="" />' +
											'关机' +
										'</p>' +
									'</div>' +
									'<div class="miner_footer_two">'+
										'<p class="start_open open_box">'+
											'<i class="iconfont icon-guanjin"></i>' + '开机' +
										'</p>'+
									'</div>'+
								'</div>' +
								'<div class="delete_miner low_height" uuid="'+ t.uuid +'">' +
									'<i class="iconfont icon-shanchu"></i>' +
									'<p>' + '删除' + '</p>'+
								'</div>' +
							'</div>'
						}
					});
					$('#cart_list').html(cart_list);
				}
			}
		
		</script>
	</body>

</html>