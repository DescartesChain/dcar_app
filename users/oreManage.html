<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/oreManage.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">矿机管理</h1>
			<i class="iconfont icon-saoma mui-pull-right saoma_btn newact" url="/users/barcode.html"></i>
		</header>
		<div class="mui-content between">
			<div class="mill_top">
				<p class="first_line">历史总收益</p>
				<p class="second_line">
					<span id="balance">0</span>
					<span class="first_line">DCAR</span>
				</p>
				<p class="third_line">
					昨日收益
					<span id="balanceCNY">0</span>
					DCAR
				</p>
			</div>
			<div class="miner_list" id="cart_list">
				<!--
				status：
				0：是托管矿机 isEntity--no:提示该设备已经离线
				1：提示 该设备初始化中
				2：提示 该设备升级中
				3：查看address值
				address：
				0：未绑定钱包——提示 绑定钱包
				1：绑定指令已发送——提示 绑定钱包指令已发送
				2：解绑指令已发送——提示 解绑指令已发送
				0x..:钱包地址 ——提示 挖矿中 **
				-->
				<!--status=3 && address存在地址-->
				<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">
								已绑定钱包
								<i class="iconfont icon-xiugai1 alter_name"></i>
							</h5>
							<p class="status stay">
								<img src="../img/greenPic.png" alt="" />
								挖矿中
							</p>
						</div>
						<div class="miner_content">
							<ul class="miner_income">
								<li>
									<h6>收益（DCAR/day）</h6>
									<p>452138</p>
								</li>
								<li>
									<h6>算力值（KH/S）</h6>
									<p>452138</p>
								</li>
							</ul>
						</div>
						<div class="miner_footer">
							<p class="deleteWallet">
								<i class="iconfont icon-qianbao" style="font-size: 16px;"></i>解绑钱包
							</p>
							<p class="seek_deatil" income="'+ t.balance +'" address="'+ t.address +'" name="'+ t.name +'" uuid="'+ t.uuid +'">
								<i class="iconfont icon-xiangqing"></i>查看详情
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>
				<!--status=3 && address==0 (提示绑定钱包)-->
				<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">
								未绑定钱包
								<i class="iconfont icon-xiugai1 alter_name"></i>
							</h5>
							<p class="status stop">
								<img src="../img/yellowPic.png" alt="" />
								空闲中
							</p>
						</div>
						<div class="miner_content_two">
							<img src="../img/ore/11.png" class="not_start_logo"/>
							<p class="not_start_title">您还未绑定钱包，绑定之后矿机将开始挖矿</p>
						</div>
						<div class="miner_footer_two">
							<p class="purse">
								<i style="left: 34%;" class="iconfont icon-qianbao" style="font-size: 16px;"></i>绑定钱包
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>
				<!--status=3 && address==1 (绑定指令已发送)-->
				<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">
								发送绑定指令
								<i class="iconfont icon-xiugai1 alter_name"></i>
							</h5>
							<p class="status stay">
								<img src="../img/yellowPic.png" alt="" />
								空闲中
							</p>
						</div>
						<div class="miner_content_alert">
							<img src="../img/ore/wait.png" class="not_start_logo"/>
							<p class="not_start_title">
								您的绑定钱包指令已发送，请等待
								<span>60s</span>
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>
				<!--status=3 && address==2 (解绑指令已发送)-->
				<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">
								发送解绑指令
								<i class="iconfont icon-xiugai1 alter_name"></i>
							</h5>
							<p class="status stay">
								<img src="../img/redPic.png" alt="" />
								离线
							</p>
						</div>
						<div class="miner_content_alert">
							<img src="../img/ore/wait.png" class="not_start_logo"/>
							<p class="not_start_title">
								您的解绑指令已发送，请等待
								<span>60s</span>
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>
				<!--status：0：是托管矿机 isEntity--no:提示该设备已经离线 ***--> 
				<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">
								已经离线
								<i class="iconfont icon-xiugai1 alter_name"></i>
							</h5>
							<p class="status stay">
								<img src="../img/redPic.png" alt="" />
								离线
							</p>
						</div>
						<div class="miner_content_alert">
							<img src="../img/ore/off-line.png" class="not_start_logo"/>
							<p class="not_start_title">
								您的设备已经离线
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>
				<!--status：1 该设备初始化中-->
				<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">
								设备初始化
								<i class="iconfont icon-xiugai1 alter_name"></i>
							</h5>
							<p class="status stay">
								<img src="../img/redPic.png" alt="" />
								离线
							</p>
						</div>
						<div class="miner_content_alert">
							<img src="../img/ore/init.png" class="not_start_logo"/>
							<p class="not_start_title">
								该设备初始化中
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>
				<!--status：2 该设备升级中-->
				<div class="miner_box">
					<div class="miner">
						<div class="title">
							<h5 class="name">
								设备升级中
								<i class="iconfont icon-xiugai1 alter_name"></i>
							</h5>
							<p class="status stay">
								<img src="../img/redPic.png" alt="" />
								离线
							</p>
						</div>
						<div class="miner_content_alert">
							<img src="../img/ore/upgrade.png" class="not_start_logo"/>
							<p class="not_start_title">
								该设备升级中
							</p>
						</div>
					</div>
					<div class="delete_miner">
						<i class="iconfont icon-shanchu"></i>
						<p>删除</p>
					</div>
				</div>
			</div>
			<div class="loading_box">
				<button class="loading">加载更多</button>
			</div>
		</div>
		<!--开机离线弹框-->
		<div class="mui-popover alert_box">
			<p class="alert_title">提示</p>
			<div class="alert_body" id="close">确定要离线吗？确定之后矿机将停止挖矿</div>
			<div class="alert_body" id="delete">
				<div style="margin:0 25px;">确定要删除矿机吗？删除后数据将清零</div>
				<!--<div style="margin:8px 25px 0;">你可以选择数据是否清零</div>
				<ul class="data_state">
					<li class="zero">
						<img src="../img/dataIcon.png" alt="" />
						<p>数据清零</p>
					</li>
					<li class="noZero">
						<img src="../img/dataIcon.png" alt="" />
						<p>数据不清零</p>
					</li>
				</ul>-->
			</div>
			<div class="alert_body" id="open">确定要开机吗？确定之后矿机将开始挖矿</div>
			<div class="alert_body" id="deleteWallet">确定要解绑钱包吗？</div>
			<ul class="alert_operate">
				<li class="alert_button" onclick="sureConfirm()">确定</li>
				<li class="alert_button">取消</li>
			</ul>
		</div>
		<!--详情-->
		<div class="mui-popover detail_box">
			<p class="alert_title">详情</p >
			<div class="mill_detail">
				<p class="detail_title">历史收益 （DCAR/DAY）</p >
				<div class="detail_main" id="history_detail_balance" style="padding-bottom: 21px;">加载中...</div>
				<p class="detail_title">今日收益 （DCAR/DAY）</p >
				<div class="detail_main" id="seek_deatil_balance" style="padding-bottom: 21px;">加载中...</div>
				<p class="detail_title">矿机地址</p >
				<div class="detail_main" id="seek_deatil_address">加载中...</div>
			</div>
			<div class="close_btn" onclick="detailConfirm()">关闭</div>
		</div>
		<!--修改矿机名称-->
		<div class="mui-popover alter_box">
			<p class="alert_title">修改矿机名称</p>
			<div class="alter_main">
				<input type="text" placeholder="请填写修改的矿机名称" id="millName"/>
			</div>
			<ul class="alert_operate">
				<li onclick="sureAlter()">确定</li>
				<li class="alter_button">取消</li>
			</ul>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/store/dist/store.legacy.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery-2.1.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/benben.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var timer = null;
			var page = 1; //第几页
			var pageSize = 20; // 每页多少条记录，-1 不分页
			var loadPageSize = 20;
			loadmillList(pageSize); // 获取矿机列表
			var alertState;
			var currentId;
			var unbindNo; // 解绑钱包下标
			var stateList = []; //矿机状态列表
			var millList; // 矿机列表
			var millListData = []; //矿机列表（数组）
			// var balanceTotal = 0; // 收益总和
			var millName;// 矿机名称
			var loadingList = "";
			var addressState = undefined; // 矿机地址状态
			var count = undefined; // 倒计时状态
			var bindIndex; // 绑定钱包下标
			var loadState; // 是否点击加载更多
			// 关闭详情
			function detailConfirm(){
				mui('.detail_box').popover('toggle');
			}
			function loadMinerList() {
				$('#cart_list').empty();
				cart_list = '';
				page = 1;
				loadmillList(loadPageSize); // 获取矿机列表
			}
			// 确定修改矿机名称
			function sureAlter(){
				mui.showLoading("保存中...", "div");
				// 矿机名称 
				millName = $('#millName').val();
				if (millName == '' || millName == undefined) {
					mui.toast('矿机名称不能为空');
					return false;
				};
				$.ajax({
				  type: "put",    // 接口类型
				  url: api + "miners/" + currentId,  // 接口地址
				  data: {
		 		  	name:millName
				  },  // 参数
				  beforeSend: function(xhr) {
				    xhr.setRequestHeader('x-requested-with', store.get("userInfo").token); // 需要携带的头部
				  },
				  async: true,
				  success: function(ret) {
				    mui.hideLoading();
				    if(ret.success) {
				      mui.toast('保存成功');
				      page = 1;
				      loadmillList(loadPageSize); // 获取矿机列表
				      mui('.alter_box').popover('hide');
				      $('#millName').val(millName)
				    } else{
				      mui.toast(ret.msg);
				    }
				  },
				  error: function(error) {
				    mui.hideLoading();
				    mui.toast(error.responseJSON.msg);
				  }
				})
			};
			// 页面定时加载
			function webTiming(){
				//定时加载
				clearInterval(timer);
				timer = setInterval(function(){
				   clearInterval(empty);
				   	page = 1;
				   	loadmillList(loadPageSize); // 获取矿机列表
				},90000)
			};
			webTiming();
			mui.plusReady(function() {
				$('.zero').css('border','3px solid #E57143');
				// 点击清零
				$('.zero').on("click",function(){
					$('.zero').css('border','3px solid #E57143');
					$('.noZero').css('border','none');
				});
				// 点击不清零
				$('.noZero').on("click",function(){
					$('.noZero').css('border','3px solid #E57143');
					$('.zero').css('border','none');
				});
				$('.loading').html('加载中...');
				// 点击加载更多
				$('.loading_box').on("click",function(){
					if($('.loading').html() == '已加载全部'){
						mui.toast('已加载全部内容');
						return false;
					}
					page = loadPageSize / pageSize;
					page ++;
					loadState = 1; //已点击加载更多
					loadPageSize = page * pageSize;
					loadingMore();
					$('.loading').html('加载中...');
				});
				// 关闭提示框
				$(".alert_button").on("click", function() {
					mui('.alert_box').popover('toggle');
				});
				// 关闭修改名称框
				$(".alter_button").on("click", function() {
					mui('.alter_box').popover('toggle');
				});
				// 绑定钱包
				$("#cart_list").on("click", ".purse", function() {
					clearInterval(timer);
					bindIndex = $(this).attr("bindIndex");
					addressState = 1; // address状态--绑定指令已发送
					mui.openWindow({
						url: '/users/addOre.html',
						id: '/users/addOre.html',
						extras: {
							minerName: $(this).attr("name"),
							uuid: $(this).attr("uuid"),
//							bindIndex:$(this).attr("bindIndex"),
						},
						waiting: {
							autoShow: false,
						}
					})
			    });
			    // 查看详情
			    $("#cart_list").on("click", ".seek_deatil", function() {
			    	$("#seek_deatil_address").html($(this).attr("address"));
			    	$("#seek_deatil_balance").html($(this).attr("income"));
			    	$("#history_detail_balance").html($(this).attr("history"));
					mui('.detail_box').popover('toggle');
					currentId = $(this).attr("uuid");
				});
				// 修改矿机名称
			    $("#cart_list").on("click", ".alter_name", function() {
					mui('.alter_box').popover('toggle');
					currentId = $(this).attr("uuid");
					$('#millName').val('');
				});
			    // 开机
			    $("#cart_list").on("click", ".start_open", function() {
					mui('.alert_box').popover('toggle');
					alertState = 'open';
					currentId = $(this).attr("uuid");
					$('#delete').hide();
					$('#close').hide();
					$('#open').show();
					$('#deleteWallet').hide();
				});
				// 离线
			    $("#cart_list").on("click", ".shut_down", function() {
					mui('.alert_box').popover('show');
					alertState = 'close';
					currentId = $(this).attr("uuid");
					$('#delete').hide();
					$('#close').show();
					$('#open').hide();
					$('#deleteWallet').hide();
				});
				// 删除矿机
				$("#cart_list").on("click", ".delete_miner", function() {
					mui('.alert_box').popover('show');
					alertState = 'delete';
					currentId = $(this).attr("uuid");
					$('#delete').show();
					$('#close').hide();
					$('#open').hide();
					$('#deleteWallet').hide();
				}); 
				// 解绑钱包
				$("#cart_list").on("click", ".deleteWallet", function() {
					mui('.alert_box').popover('show');
					alertState = 'deleteWallet';
					currentId = $(this).attr("uuid");
					unbindNo = $(this).attr("number");
//					alert(unbindNo);
					$('#delete').hide();
					$('#close').hide();
					$('#open').hide();
					$('#deleteWallet').show();
				});
			});
			// 确定 
			function sureConfirm(){
				if (alertState == 'delete') { // 删除矿机
					mui.showLoading("删除中...", "div");
					$.ajax({
						type: "delete",
						url: api + "miners/owner",
						data: {
							uuid: currentId
						},
						beforeSend: function(xhr) {
							xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
						},
						async: true,
						success: function(ret) {
							mui.hideLoading();
							if(ret.success) {
								mui.toast('删除成功');
								page = 1;
								loadmillList(loadPageSize); // 获取矿机状态列表
							} else {
								mui.toast(ret.msg);
							}
						},
						error: function(error) {
							mui.hideLoading();
							mui.toast(error.responseJSON.msg);
						}
					});
					return false;
				}
				if (alertState == 'open') { //启动矿机
					mui.showLoading("启动中...", "div");
					$.ajax({
						type: "get",
						url: api + "miners/" + currentId + '/init',
						data: {},
						beforeSend: function(xhr) {
							xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
						},
						async: true,
						success: function(ret) {
							mui.hideLoading();
							if(ret.success) {
								mui.toast('启动成功');
								page = 1;
								loadmillList(loadPageSize); // 获取矿机状态列表
							} else {
								mui.toast(ret.msg);
							}
						},
						error: function(error) {   
							mui.hideLoading();
							mui.toast(error.responseJSON.msg);
						}
					});
					return false;
				}
				if (alertState == 'deleteWallet') { //解绑钱包
					mui.showLoading("删除中...", "div");
					$.ajax({
						type: "delete",
						url: api + "miners/account",
						data: {
							uuid: currentId
						},
						beforeSend: function(xhr) {
							xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
						},
						async: true,
						success: function(ret) {
							mui.hideLoading();
							if(ret.success) {
								mui.toast('解绑指令已发送');
								addressState = 2; // 解绑指令已发送
								page = 1;
								loadmillList(loadPageSize); // 获取矿机状态列表
							} else {
								mui.toast(ret.msg);
							}
						},
						error: function(error) {
							mui.hideLoading();
							mui.toast(error.responseJSON.msg);
						}
					});
					return false;
				}
				
			}
			var goods = [];
			var cart_list = '';
			// 获取矿机列表
			function loadmillList(size) {
				// console.log(api + "miners?page=" + page + '&pageSize=' + size);
				$('#cart_list').empty();
				cart_list = '';
				mui.showLoading("加载中...", "div");
				$.ajax({
					type: "get",
					url: api + "miners?page=" + page + '&pageSize=' + size,
					data: {},
					beforeSend: function(xhr) {
						xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
					},
					async: true,
					success: function(ret) {
						mui.hideLoading();
						if(ret.success) {
							mui.toast('加载成功');
							millList = ret.data; //矿机列表
							millListData = ret.data.list; // 矿机列表（数组）
						    // balanceTotal = ret.data.user.historyProfit.toFixed(2); // 历史总收益
							$('#balance').html(ret.data.user.historyProfit.toFixed(2));  // 历史总收益
							$('#balanceCNY').html(ret.data.user.yesterdayProfit.toFixed(2))  // 昨日收益
							// 绑定钱包
							if (addressState == 1){
//								alert(addressState);
								for(var i =0;i<millListData.length;i++){
									if (millListData[i]._id == bindIndex){
										millListData[i].address = 1; // 绑定指令已发送
									}
								}
							};
							// 倒计时后的判断（绑定）
							if (count == 1){
								for(var i =0;i<millListData.length;i++){
									if (millListData[i]._id == bindIndex){
										if(millListData[i].address == 0){
											mui.toast('绑定钱包失败');
										} else {
											mui.toast('绑定钱包成功');
										}
									}
								}
								count = undefined;
							};
							// 解绑
							if(addressState == 2) {
								for(var i =0;i<millListData.length;i++){
									if(millListData[i]._id == unbindNo){
										millListData[i].address = 2; // 解绑
									}
								}
							};
							// 倒计时后的判断（解绑）
							if (count == 2){
								for(var i =0;i<millListData.length;i++){
									if(millListData[i]._id == unbindNo){
										if(millListData[i].address == 0){
											mui.toast('解绑钱包成功');
										} else {
											mui.toast('解绑钱包失败');
										}
									}
								}
								count = undefined;
							};
							complete(); // 最终合成
						} else {
							mui.toast(ret.msg);
						}
					},
					error: function(error) {
						mui.hideLoading();
						mui.toast(error.responseJSON.msg);
					}
				})
			};

			$("#cart_list").on("swipeleft", ".miner", function() {
				$(".miner_box").find(".delete_miner").css("right", "-85px")
				$(".miner_box").find(".miner").css("margin-left", "0")
				$(this).parent().find(".delete_miner").css("right", "0")
				$(this).parent().find(".miner").css("margin-left", "-85px")
			});
			$("#cart_list").on("swiperight", ".miner", function() {
				$(this).parent().find(".delete_miner").css("right", "-85px")
				$(this).parent().find(".miner").css("margin-left", "0")
			});
			// 合成页面
			function complete() {
				if(millList.list.length > 0) {
					$.each(millList.list, function(i, t) {
		//				status：
		//				0：是托管矿机 isEntity--no:提示该设备已经离线
		//				1：提示 该设备初始化中
		//				2：提示 该设备升级中
		//				3：查看address值
			//				address：
			//				0：未绑定钱包——提示 绑定钱包
			//				1：绑定指令已发送——提示 绑定钱包指令已发送
			//				2：解绑指令已发送——提示 解绑指令已发送
			//				0x..:钱包地址 ——提示 挖矿中 
						if (t.status == 0){
							//设备离线
							cart_list +=
								'<div class="miner_box">' +
									'<div class="miner">' +
										'<div class="title">'+
											'<h5 class="name">'+
												t.name +
												'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>'+
											'</h5>'+
											'<p class="status stay">'+
												'<img src="../img/redPic.png" alt="" />' +
												'离线'+
											'</p>'+
										'</div>'+
										'<div class="miner_content_alert">'+
											'<img src="../img/ore/off-line.png" class="not_start_logo"/>'+
											'<p class="not_start_title">'+
												'您的设备已经离线'+
											'</p>'+
										'</div>'+
									'</div>'+
									'<div class="delete_miner" uuid="'+ t.uuid +'">'+
										'<i class="iconfont icon-shanchu"></i>'+
										'<p>' + '删除' + '</p>'+
									'</div>'+
								'</div>';
						} else if(t.status == 1){
							//设备初始化中
							cart_list +=
							'<div class="miner_box">' +
								'<div class="miner">' +
									'<div class="title">' +
										'<h5 class="name">' +
											t.name +
											'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
										'</h5>' +
										'<p class="status stay">' +
											'< img src="../img/redPic.png" alt="" />' +
											'离线' +
										'</p>' +
									'</div>' +
									'<div class="miner_content_alert">' +
										'<img src="../img/ore/init.png" class="not_start_logo"/>' +
										'<p class="not_start_title">' +
											'该设备初始化中' +
										'</p>' +
									'</div>' +
								'</div>' +
								'<div class="delete_miner" uuid="'+ t.uuid +'">' +
									'<i class="iconfont icon-shanchu"></i>' +
									'<p>删除</p>' +
								'</div>' +
							'</div>';
						} else if (t.status == 2){
							//该设备升级中
							cart_list +=
							'<div class="miner_box">'+
								'<div class="miner">'+
									'<div class="title">'+
										'<h5 class="name">' +
											t.name +
											'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
										'</h5>' +
										'<p class="status stay">'+
											'<img src="../img/redPic.png" alt="" />'+
											'离线'+
										'</p>'+
									'</div>'+
									'<div class="miner_content_alert">'+
										'<img src="../img/ore/upgrade.png" class="not_start_logo"/>'+
										'<p class="not_start_title">'+
											'该设备升级中'+
										'</p>'+
									'</div>'+
								'</div>'+
								'<div class="delete_miner" uuid="'+ t.uuid +'">' +
									'<i class="iconfont icon-shanchu"></i>' +
									'<p>删除</p>' +
								'</div>' +
							'</div>';
						} else if (t.status == 3){
							if(t.address == 0){
								//未绑定钱包
								cart_list +=
								'<div class="miner_box">' +
									'<div class="miner">' +
										'<div class="title">' +
											'<h5 class="name">' +
												t.name +
												'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
											'</h5>' +
											'<p class="status stop">' +
												'<img src="../img/yellowPic.png" alt="" />' +
												'空闲中' +
											'</p>' +
										'</div>' +
										'<div class="miner_content_two">' +
											'<img src="../img/ore/11.png" class="not_start_logo"/>' +
											'<p class="not_start_title">您还未绑定钱包，绑定之后矿机将开始挖矿</p>' +
										'</div>' +
										'<div class="miner_footer_two">' +
											'<p class="purse" name="'+ t.name +'" uuid="'+ t.uuid +'" bindIndex="'+ t._id +'">' +
												'<i style="left: 34%;" class="iconfont icon-qianbao" style="font-size: 16px;"></i>' + '绑定钱包' +
											'</p>' +
										'</div>' +
									'</div>' +
									'<div class="delete_miner" uuid="'+ t.uuid +'">' +
										'<i class="iconfont icon-shanchu"></i>' +
										'<p>删除</p>' +
									'</div>' +
								'</div>';
							}else if (t.address == 1){
								//绑定指令已发送	
								cart_list +=
								'<div class="miner_box">'+
									'<div class="miner">'+
										'<div class="title">'+
											'<h5 class="name">' +
												t.name +
												'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
											'</h5>' +
											'<p class="status stay">'+
												'<img src="../img/yellowPic.png" alt="" />'+
												'空闲中'+
											'</p>'+
										'</div>'+
										'<div class="miner_content_alert">'+
											'<img src="../img/ore/wait.png" class="not_start_logo"/>'+
											'<p class="not_start_title">'+
												'您的绑定钱包指令已发送，请等待'+
												'<span class="time">' + '60s' +'</span>'+
											'</p>'+
										'</div>'+
									'</div>'+
									'<div class="delete_miner" uuid="'+ t.uuid +'">' +
										'<i class="iconfont icon-shanchu"></i>' +
										'<p>删除</p>' +
									'</div>' +
								'</div>';
								countTime();
							}else if (t.address == 2){
								//解绑指令已发送
								cart_list +=
								'<div class="miner_box">'+
									'<div class="miner">'+
										'<div class="title">'+
											'<h5 class="name">' +
												t.name +
												'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
											'</h5>' +
											'<p class="status stay">'+
												'<img src="../img/redPic.png" alt="" />'+
												'离线'+
											'</p>'+
										'</div>'+
										'<div class="miner_content_alert">' +
											'<img src="../img/ore/wait.png" class="not_start_logo"/>'+
											'<p class="not_start_title">'+
												'您的解绑指令已发送，请等待'+
												'<span class="time">' + '60s' + '</span>' +
											'</p>'+
										'</div>'+
									'</div>'+
									'<div class="delete_miner" uuid="'+ t.uuid +'">' +
										'<i class="iconfont icon-shanchu"></i>' +
										'<p>删除</p>' +
									'</div>' +
								'</div>';
								countTime();
							}else{
//								alert(t.balance);
								//挖矿中
								cart_list +=
								'<div class="miner_box">' +
									'<div class="miner">' +
										'<div class="title">' +
											'<h5 class="name">' + t.name + '<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>'+'</h5>' +
											'<p class="status" id="doing">' + 
												'<img src="../img/greenPic.png" alt="" />' +
												'挖矿中' +
											'</p>' +
										'</div>' +
										'<div class="miner_content">' +
											'<ul class="miner_income">' +
												'<li>' +
													'<h6>' + '今日收益（DCAR/day）' + '</h6>' +
													'<p>' + t.balance + '</p>' +
												'</li>' +
												'<li>' +
													'<h6>' + '算力值（KH/S）' + '</h6>' +
													'<p>' + t.hashrate + '</p>' +
												'</li>' +
											'</ul>'+
										'</div>' +
										'<div class="miner_footer">' +
											'<p class="deleteWallet" uuid="'+ t.uuid +'" number="'+ t._id +'">' +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
												'<i class="iconfont icon-qianbao" style="font-size: 16px;"></i>' + '解绑钱包' +
											'</p>' +
											'<p class="seek_deatil" history="'+ t.historyProfit +'" income="'+ t.balance +'" address="'+ t.address +'" name="'+ t.name +'" uuid="'+ t.uuid +'">' +
												'<i class="iconfont icon-xiangqing"></i>' + '查看详情' +
											'</p>' +
										'</div>' +
									'</div>' +
									'<div class="delete_miner" uuid="'+ t.uuid +'">' +
										'<i class="iconfont icon-shanchu"></i>' +
										'<p>' + '删除' + '</p>'+
									'</div>' +
								'</div>';
							}
						} 
					});
					$('#cart_list').html(cart_list);
				}
				if ($(".miner_box").length >= millList.count){
					$('.loading').html('已加载全部');
				} else {
					$('.loading').html('加载更多');
				}
			};
			// 加载更多方法
			function loadingMore() {
				loadingList = '';
				mui.showLoading("加载中...", "div");
				$.ajax({
					type: "get",
					url: api + "miners?page=" + page + '&pageSize=' + pageSize,
					data: {},
					beforeSend: function(xhr) {
						xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
					},
					async: true,
					success: function(ret) {
						mui.hideLoading();
						if(ret.success) {
							mui.toast('加载成功');
							millList = ret.data; //矿机列表
							millListData = ret.data.list; // 矿机列表（数组）
							// 绑定钱包
							if (addressState == 1){
								for(var i =0;i<millListData.length;i++){
									if (millListData[i]._id == bindIndex){
										millListData[i].address = 1; // 绑定指令已发送
									}
								}
							};
							// 倒计时后的判断（绑定）
							if (count == 1){
								for(var i =0;i<millListData.length;i++){
									if (millListData[i]._id == bindIndex){
										if(millListData[i].address == 0){
											mui.toast('绑定钱包失败');
										} else {
											mui.toast('绑定钱包成功');
										}
									}
								}
								count = undefined;
							};
							// 解绑
							if(addressState == 2) {
								for(var i =0;i<millListData.length;i++){
									if(millListData[i]._id == unbindNo){
										millListData[i].address = 2; // 解绑
									}
								}
							};
							// 倒计时后的判断（解绑）
							if (count == 2){
								for(var i =0;i<millListData.length;i++){
									if(millListData[i]._id == unbindNo){
										if(millListData[i].address == 0){
											mui.toast('解绑钱包成功');
										} else {
											mui.toast('解绑钱包失败');
										}
									}
								}
								count = undefined;
							};
							$.each(millListData, function(i, t) {
								if (t.status == 0){
									//设备离线
									loadingList +=
										'<div class="miner_box">' +
											'<div class="miner">' +
												'<div class="title">'+
													'<h5 class="name">'+
														t.name +
														'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>'+
													'</h5>'+
													'<p class="status stay">'+
														'<img src="../img/redPic.png" alt="" />' +
														'离线'+
													'</p>'+
												'</div>'+
												'<div class="miner_content_alert">'+
													'<img src="../img/ore/off-line.png" class="not_start_logo"/>'+
													'<p class="not_start_title">'+
														'您的设备已经离线'+
													'</p>'+
												'</div>'+
											'</div>'+
											'<div class="delete_miner" uuid="'+ t.uuid +'">'+
												'<i class="iconfont icon-shanchu"></i>'+
												'<p>' + '删除' + '</p>'+
											'</div>'+
										'</div>';
								} else if(t.status == 1){
									//设备初始化中
									loadingList +=
									'<div class="miner_box">' +
										'<div class="miner">' +
											'<div class="title">' +
												'<h5 class="name">' +
													t.name +
													'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
												'</h5>' +
												'<p class="status stay">' +
													'< img src="../img/redPic.png" alt="" />' +
													'离线' +
												'</p>' +
											'</div>' +
											'<div class="miner_content_alert">' +
												'<img src="../img/ore/init.png" class="not_start_logo"/>' +
												'<p class="not_start_title">' +
													'该设备初始化中' +
												'</p>' +
											'</div>' +
										'</div>' +
										'<div class="delete_miner" uuid="'+ t.uuid +'">' +
											'<i class="iconfont icon-shanchu"></i>' +
											'<p>删除</p>' +
										'</div>' +
									'</div>';
								} else if (t.status == 2){
									//该设备升级中
									loadingList +=
									'<div class="miner_box">'+
										'<div class="miner">'+
											'<div class="title">'+
												'<h5 class="name">' +
													t.name +
													'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
												'</h5>' +
												'<p class="status stay">'+
													'<img src="../img/redPic.png" alt="" />'+
													'离线'+
												'</p>'+
											'</div>'+
											'<div class="miner_content_alert">'+
												'<img src="../img/ore/upgrade.png" class="not_start_logo"/>'+
												'<p class="not_start_title">'+
													'该设备升级中'+
												'</p>'+
											'</div>'+
										'</div>'+
										'<div class="delete_miner" uuid="'+ t.uuid +'">' +
											'<i class="iconfont icon-shanchu"></i>' +
											'<p>删除</p>' +
										'</div>' +
									'</div>';
								} else if (t.status == 3){
									if(t.address == 0){
										//未绑定钱包
										loadingList +=
										'<div class="miner_box">' +
											'<div class="miner">' +
												'<div class="title">' +
													'<h5 class="name">' +
														t.name +
														'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
													'</h5>' +
													'<p class="status stop">' +
														'<img src="../img/yellowPic.png" alt="" />' +
														'空闲中' +
													'</p>' +
												'</div>' +
												'<div class="miner_content_two">' +
													'<img src="../img/ore/11.png" class="not_start_logo"/>' +
													'<p class="not_start_title">您还未绑定钱包，绑定之后矿机将开始挖矿</p>' +
												'</div>' +
												'<div class="miner_footer_two">' +
													'<p class="purse" name="'+ t.name +'" uuid="'+ t.uuid +'" bindIndex="'+ t._id +'">' +
														'<i style="left: 34%;" class="iconfont icon-qianbao" style="font-size: 16px;"></i>' + '绑定钱包' +
													'</p>' +
												'</div>' +
											'</div>' +
											'<div class="delete_miner" uuid="'+ t.uuid +'">' +
												'<i class="iconfont icon-shanchu"></i>' +
												'<p>删除</p>' +
											'</div>' +
										'</div>';
									}else if (t.address == 1){
										//绑定指令已发送
										loadingList +=
										'<div class="miner_box">'+
											'<div class="miner">'+
												'<div class="title">'+
													'<h5 class="name">' +
														t.name +
														'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
													'</h5>' +
													'<p class="status stay">'+
														'<img src="../img/yellowPic.png" alt="" />'+
														'空闲中'+
													'</p>'+
												'</div>'+
												'<div class="miner_content_alert">'+
													'<img src="../img/ore/wait.png" class="not_start_logo"/>'+
													'<p class="not_start_title">'+
														'您的绑定钱包指令已发送，请等待'+
														'<span class="time">' + '60s' +'</span>'+
													'</p>'+
												'</div>'+
											'</div>'+
											'<div class="delete_miner" uuid="'+ t.uuid +'">' +
												'<i class="iconfont icon-shanchu"></i>' +
												'<p>删除</p>' +
											'</div>' +
										'</div>';
										countTime();
									}else if (t.address == 2){
										//解绑指令已发送
										loadingList +=
										'<div class="miner_box">'+
											'<div class="miner">'+
												'<div class="title">'+
													'<h5 class="name">' +
														t.name +
														'<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>' +
													'</h5>' +
													'<p class="status stay">'+
														'<img src="../img/redPic.png" alt="" />'+
														'离线'+
													'</p>'+
												'</div>'+
												'<div class="miner_content_alert">' +
													'<img src="../img/ore/wait.png" class="not_start_logo"/>'+
													'<p class="not_start_title">'+
														'您的解绑指令已发送，请等待'+
														'<span class="time">' + '60s' + '</span>' +
													'</p>'+
												'</div>'+
											'</div>'+
											'<div class="delete_miner" uuid="'+ t.uuid +'">' +
												'<i class="iconfont icon-shanchu"></i>' +
												'<p>删除</p>' +
											'</div>' +
										'</div>';
										countTime();
									}else{
										//挖矿中
										loadingList +=
										'<div class="miner_box">' +
											'<div class="miner">' +
												'<div class="title">' +
													'<h5 class="name">' + t.name + '<i class="iconfont icon-xiugai1 alter_name" uuid="'+ t.uuid +'"></i>'+'</h5>' +
													'<p class="status" id="doing">' + 
														'<img src="../img/greenPic.png" alt="" />' +
														'挖矿中' +
													'</p>' +
												'</div>' +
												'<div class="miner_content">' +
													'<ul class="miner_income">' +
														'<li>' +
															'<h6>' + '收益（DCAR/day）' + '</h6>' +
															'<p>' + t.balance + '</p>' +
														'</li>' +
														'<li>' +
															'<h6>' + '算力值（KH/S）' + '</h6>' +
															'<p>' + t.hashrate + '</p>' +
														'</li>' +
													'</ul>'+
												'</div>' +
												'<div class="miner_footer">' +
													'<p class="deleteWallet" uuid="'+ t.uuid +'" number="'+ t._id +'">' +
														'<i class="iconfont icon-qianbao" style="font-size: 16px;"></i>' + '解绑钱包' +
													'</p>' +
													'<p class="seek_deatil" income="'+ t.balance +'" address="'+ t.address +'" name="'+ t.name +'" uuid="'+ t.uuid +'">' +
														'<i class="iconfont icon-xiangqing"></i>' + '查看详情' +
													'</p>' +
												'</div>' +
											'</div>' +
											'<div class="delete_miner" uuid="'+ t.uuid +'">' +
												'<i class="iconfont icon-shanchu"></i>' +
												'<p>' + '删除' + '</p>'+
											'</div>' +
										'</div>';
									}
								} 
							});
							var minerList = document.body.querySelector('#cart_list');
							var Div = document.createElement('div');
							// Div.className = 'mui-table-view-cell';
							Div.innerHTML = loadingList;
							minerList.appendChild(Div);
							if ($(".miner_box").length >= millList.count){
								$('.loading').html('已加载全部');
							} else {
								$('.loading').html('加载更多');
							}
						} else {
							mui.toast(ret.msg);
						}
					},
					error: function(error) {
						mui.hideLoading();
						mui.toast(error.responseJSON.msg);
					}
				})
			};
			//倒计时
			var empty = null;
			function countTime(){
				var time = 60;
				clearInterval(empty);
				empty = setInterval(function() {
					if(time > 1) {
						time--;
						$(".time").html(time + 's');
					} else {
						$(".time").html('60s');
						clearInterval(empty);
						webTiming();
						// console.log(addressState);
						// 绑定钱包
						if (addressState == 1){ 
							count = 1;
						}
						// 解绑钱包
						if (addressState == 2){ 
							count = 2;
						}
						addressState = '';
						page = 1;
						loadmillList(loadPageSize); // 获取矿机列表
					}
				}, 1000);
			};
		
		</script>
	</body>

</html>