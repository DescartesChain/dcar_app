<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>资产</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/property.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">资产</h1>
		</header>
		<div class="mui-content property_main">
			<!--无-->
			<div class="property_card blue_bg" id="creat_dcar">
				<span url="/property/create-wallet.html" id="createDcar">新建DCAR</span>
				<span class="newact" url="/property/import-dcar.html">导入DCAR</span>
			</div>
			<div id="dcar_purse"></div>
			<div class="property_card black_bg" id="import_eth" onclick="import_wallet('ETH')">
				<span>导入ETH钱包</span>
			</div>
			<div id="eth_purse"></div>
			<div class="property_card yellow_bg" onclick="import_wallet('BTC')">
				<span>导入BTC钱包</span>
			</div>
			<!--有-->
			<!--<div class="yellow_bg card_one mui-row" id="eth_purse" onclick="go_detail(2)">
				<div class="mui-col-sm-3 mui-col-xs-3">
					<img src="../img/property/wallet.png" alt="" />
				</div>
				<div class="mui-col-sm-9 mui-col-xs-9">
					<div>ETH-Wallet</div>
					<div>0.000DCAR</div>
					<div>&yen;0.00</div>
					<div>0xbsdakdhkdsidusidshhskkh</div>
				</div>
			</div>
			<div class="black_bg card_one mui-row" id="btc_purse" onclick="go_detail(3)">
				<div class="mui-col-sm-3 mui-col-xs-3">
					<img src="../img/property/wallet.png" alt="" />
				</div>
				<div class="mui-col-sm-9 mui-col-xs-9">
					<div>BTC-Wallet</div>
					<div>0.000DCAR</div>
					<div>&yen;0.00</div>
					<div>0xbsdakdhkdsidusidshhskkh</div>
				</div>
			</div>-->
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/store/dist/store.legacy.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery-2.1.1.min.js"></script>
		<script src="../js/benben.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/web3.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			showDcarPurse();
			showEthPurse();
			$("#createDcar").on("click", function(){
				if (!store.get("userInfo")) {
					mui.toast('请先登录');
					return false;
				}
				mui.openWindow({
					id: "/property/create-wallet.html",
					url: "/property/create-wallet.html",
					extras: {
						status: 0
					}
				})
			})
			//打开详情页
			function go_detail(num, state) {
				mui.openWindow({
					id: "account-main.html",
					url: "../property/account-main.html",
					extras: {
						targetId: state,
						purseIndex: num
					},
					show: {
						aniShow: "slide-in-right", //页面显示动画，默认为”slide-in-right“；
					},
				})
			}

			// 导入钱包
			function import_wallet(state) {
				mui.openWindow({
					id: "../property/import-wallet.html",
					url: "../property/import-wallet.html",
					extras: {
						targetId: state
					},
					show: {
						aniShow: "slide-in-right", //页面显示动画，默认为”slide-in-right“；
					},
				})
			}
			// 显示dcar钱包
			function showDcarPurse() {
				var arr = store.get('dcarPurse');
				if(arr == undefined || arr == null || arr == "") {
					$("#dcar_purse").hide();
					var dcarArray = []
					store.set('dcarPurse', dcarArray)
				} else {
					if(arr.length == 0) {
						$("#dcar_purse").hide();
					} else {
						var dcar = 1;
						var item='';
						gerAccountBalance();
						$.each(arr, function(i, t) {
							item+='<div class="blue_bg card_one mui-row" onclick="go_detail(' + i + "," + dcar+')">'
										+'<div class="mui-col-sm-3 mui-col-xs-3">'
											+'<img src="../img/property/wallet.png" alt="" />'
										+'</div>'
										+'<div class="mui-col-sm-6 mui-col-xs-6">'
											+'<div>'+ t.name +'</div>'
											+'<div>'+ t.money +'DCAR</div>'
											+'<div>&yen;'+ t.money +'</div>'
											+'<div>'+ t.address +'</div>'
										+'</div>'
										+'<div class="mui-col-sm-3 mui-col-xs-3">'
											+'<p>'
												+'<span>买入</span>'
											+'</p >'
											+'<p>'
												+'<span>卖出</span>'
											+'</p >'
										+'</div>'
									+'</div>'
						});
						$("#dcar_purse").html(item)
						$("#dcar_purse").show();
					}
				}
			}
			// 显示ETH钱包
			function showEthPurse(){
				var eth = store.get('ethPurse')
				if(eth == undefined || eth == null || eth == "") {
					$("#eth_purse").hide();
					$("#import_eth").show();
					var ethArray = []
					store.set('ethPurse', ethArray)
				} else {
					if(eth.length == 0) {
						$("#eth_purse").hide();
						$("#import_eth").show();
					} else {
						console.log(eth)
						this.ethBalance(eth[0].address, '.eth_money');
						$("#import_eth").hide();
						var dcar = 2;
						var item='';
						$.each(eth, function(i, t) {
							item+='<div class="black_bg card_one mui-row" onclick="go_detail(' + i + "," + dcar+')">'
										+'<div class="mui-col-sm-3 mui-col-xs-3">'
											+'<img src="../img/property/btn-ethereum.png" alt="" />'
										+'</div>'
										+'<div class="mui-col-sm-9 mui-col-xs-9">'
											+'<div>'+ t.name +'</div>'
											+'<div class="eth_money">0ETH</div>'
											+'<div class="eth_money">&yen;0</div>'
											+'<div>'+ t.address +'</div>'
										+'</div>'
						});
						$("#eth_purse").html(item)
						$("#eth_purse").show();
					}
				}
			}
			function ethBalance (address, cas) {
				var web3 = new Web3(ethProvider);
				web3.eth.getBalance(address)
				.then(function (result) {
					$(cas).html(web3.utils.fromWei(result, 'ether') + 'ETH');
				}).catch(function () {
					mui.toast('链接不到以太坊区块链网络');
				});
			}
			function gerAccountBalance() {
				var arr = store.get('dcarPurse');
				for (var i=0;i<arr.length;i++){
					$.ajax({
						type: "get",
						url: api + "dcarchain/account/" + arr[i].address + "/balance",
						data: {},
						async: true,
						success: function(ret) {
							
							if(ret.success) {
								arr[i].money = ret.data;
								console.log(ret.data);
							} else {
								arr[i].money = 0;
								mui.toast(ret.msg)
							}
						},
						error: function(error) {
							arr[i].money = 0;
							mui.toast(error.responseJSON.msg);
						}
					});
				}
			}
		</script>
	</body>
</html>