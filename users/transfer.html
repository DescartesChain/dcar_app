<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>转账</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css"/>
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/transfer.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">转账</h1>
		</header>
		<div class="mui-content">
			<div class="transfer_main">
				<div class="info">
					<h5>当前账户</h5>
					<div class="detail info_detail">
						<p id="userName"></p>
						<p id="userAddress"></p>
					</div>
				</div>
				<div class="info">
					<h5>转入账户</h5>
					<div class="detail">
						<div class="addressMain" style="position: relative;border: 1px solid rgba(0,0,0,.2);border-radius: 3px;margin-bottom: 15px;">
							<input style="width: 80%;border: 0;margin-bottom:0;" type="text" id="toaddress" class="mui-input-clear" placeholder="请输入钱包地址" style="padding-right: 34px;">
							<i class="iconfont icon-saoma" id="saoma"></i>
						</div>
					</div>
				</div>
				<div class="info">
					<h5>转入金额</h5>
					<div class="detail">
						<div class="mui-input-row">
							<input id="cash" value="" type="number" class="mui-input-clear" placeholder="请输入转入金额">
						</div>
					</div>
				</div>
				<div class="info">
					<h5>手续费</h5>
					<div class="detail">
						<div class="mui-input-row">
							<input id="routine" type="number" class="mui-input-clear" value="0">
						</div>
					</div>
				</div>
				<div class="info">
					<h5>钱包密码</h5>
					<div class="detail">
						<div class="mui-input-row">
							<input id="pass" type="password" placeholder="请输入钱包密码" class="mui-input-clear" value="">
						</div>
					</div>
				</div>
				<button id="submit">确认</button>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/markdown.js"></script>
		<script src="../js/store/dist/store.legacy.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/benben.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/jquery-2.1.1.min.js"></script>
		<script src="../js/web3.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/bignumber.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var web3 = new Web3(DCARapi);
			var purseInfo = store.get('dcarPurse');
			// 获取转账手续费
//			function whetherSuccess() {
//				web3.eth.getHashrate().then(function (result){
//					// var process = new Big
//					$("#routine").val(result);
//				}).catch(function () {
//					mui.toast('链接不到以太坊区块链网络');
//				});
//			}
//		    whetherSuccess();
			getUserInfo();
			// 根据用户id获取用户信息
			function getUserInfo() {
				mui.showLoading("加载中...", "div");
				$.ajax({
					type: "get",
					url: api + "user/" + store.get("userInfo").id,
					data: {},
					beforeSend: function(xhr) {
						xhr.setRequestHeader('x-requested-with', store.get("userInfo").token);
					},
					async: true,
					success: function(ret) {
						mui.hideLoading();
						if(ret.success) {
							mui.toast('加载成功');
							$("#userName").html(ret.data.name);
						} else{
							mui.toast(ret.msg);
						}
					},
					error: function(error) {
						mui.hideLoading();
						mui.toast(error.responseJSON.msg);
					}
				})
			}
			mui.plusReady(function(){
				var self = plus.webview.currentWebview();
				address = self.address;
				purseIndex = self.purseIndex;
				// console.log(purseInfo[purseIndex].privateKey);
				$("#userAddress").html(address);
				$("#saoma").on("tap", function(){
					mui.openWindow({
						url: '/users/barcodeAddress.html',
						id: '/users/barcodeAddress.html',
						waiting: {
							autoShow: false,
						}
					});
				})
				$("#submit").on("tap", function(){
					if ($("#toaddress").val() == "") {
						mui.toast('转入账户不能为空');
						return false;
					}
					if ($("#cash").val() == "") {
						mui.toast('转入金额不能为空');
						return false;
					}
					if ($("#pass").val() == "") {
						mui.toast('密码不能为空');
						return false;
					}
					if ($("#pass").val() != purseInfo[purseIndex].password) {
						mui.toast('密码输入错误');
						return false;
					}
					mui.showLoading("加载中...", "div");
					var count = parseInt($("#cash").val());
					var toSize = $("#toaddress").val();
					var currentKey = purseInfo[purseIndex].privateKey;
					web3.eth.accounts.signTransaction({
					    to: toSize.replace(toSize.substr(0, 2), '0x'),
					    gas: $("#routine").val(),
					    value: $("#cash").val() * 100000000
					}, currentKey.replace(currentKey.substr(0, 2), '0x')).then(function(result){
						mui.hideLoading();
						beginWhether(result.rawTransaction);
					}).catch(function (error) {
						mui.hideLoading();
						mui.toast(error);
					});
				})
				getRoutine();
//				$("#submit").on("tap", function(){
//					var count = parseInt($("#cash").val());
//					var toSize = $("#toaddress").val();
//					var data = {
//						"jsonrpc":"2.0",
//						"method":"eth_sendTransaction",
//						"params":[{
//							"from": address.replace(address.substr(0, 2), '0x'),
//							"to":  toSize.replace(toSize.substr(0, 2), '0x'),
//							"value": "0x" + count.toString(16)
//						}],
//						"id":1
//					};
//					mui.showLoading("加载中...", "div");
//					$.ajax({
//						type: "post",
//						url: DCARapi,
//						beforeSend: function(xhr) {
//							xhr.setRequestHeader('Content-Type', "application/json");
//						},
//						data: JSON.stringify(data),
//						async: true,
//						success: function(ret) {
//							mui.hideLoading();
//							if(ret.result) {
//								mui.toast('加载成功');
//								whetherSuccess(ret.result);
//								return false;
//							}
//							if(ret.error) {
//								mui.toast(ret.error.message);
//							}
//						},
//						error: function(error) {
//							mui.hideLoading();
//							mui.toast(error.responseJSON.msg);
//						}
//					})
//				});
				// 开始转账
				function beginWhether(RawTransaction) {
					var data = {
						"jsonrpc":"2.0",
						"method":"eth_sendRawTransaction",
						"params":[RawTransaction],
						"id":1
					};
					mui.showLoading("交易中...", "div");
					$.ajax({
						type: "post",
						url: DCARapi,
						beforeSend: function(xhr) {
							xhr.setRequestHeader('Content-Type', "application/json");
						},
						data: JSON.stringify(data),
						async: true,
						success: function(ret) {
							mui.hideLoading();
							if(ret.result) {
								mui.toast('交易请求已发送');
								whetherSuccess(ret.result);
								return false;
							}
							if(ret.error) {
								mui.toast(ret.error.message);
							}
						},
						error: function(error) {
							mui.hideLoading();
							mui.toast(error.responseJSON.msg);
						}
					})
				}
				// 验证是否转账成功
//				function whetherSuccess(result) {
//					var data = {
//						"jsonrpc":"2.0",
//						"method":"eth_getTransactionReceipt",
//						"params":[result],
//						"id":1
//					};
//					mui.showLoading("转账中...", "div");
//					$.ajax({
//						type: "post",
//						url: DCARapi,
//						beforeSend: function(xhr) {
//							xhr.setRequestHeader('Content-Type', "application/json");
//						},
//						data: JSON.stringify(data),
//						async: true,
//						success: function(ret) {
//							mui.hideLoading();
//							if(ret.result) {
//								mui.toast('转账成功');
//								return false;
//							}
//							if(ret.error){
//								mui.toast(ret.error.message);
//							}
//						},
//						error: function(error) {
//							mui.hideLoading();
//							mui.toast(error.responseJSON.msg);
//						}
//					})
//				}
				// 获取转账手续费
				function getRoutine() {
					var data = {
						"jsonrpc":"2.0",
						"method":"eth_gasPrice",
						"params":[],
						"id":73
					}
					// mui.showLoading("加载中...", "div");
					$.ajax({
						type: "post",
						url: DCARapi,
						beforeSend: function(xhr) {
							xhr.setRequestHeader('Content-Type', "application/json");
						},
						data: JSON.stringify(data),
						async: true,
						success: function(ret) {
							mui.hideLoading();
							if(ret.result) {
								// mui.toast('手续费加载成功');
								var process = new BigNumber(ret.result);
								$("#routine").val(process.c[0]);
								return false;
							}
							if(ret.error){
								mui.toast(ret.error.message);
							}
						},
						error: function(error) {
							mui.hideLoading();
							mui.toast(error.responseJSON.msg);
						}
					})
				}
			})
			function getResult() {
				if(store.get("toAddress") != undefined || store.get("toAddress") != null) {
					$("#toaddress").val(store.get("toAddress"));
					store.remove("toAddress");
				}
			}
		</script>
	</body>

</html>